#!/bin/bash
#
# netmrg_cron.sh
#
# a shell script to remove lockfiles and rotate output if it died
#

prefix="@prefix@"
exec_prefix="@exec_prefix@"
localstatedir="@localstatedir@"
prog="@PACKAGE@"

mailto="root"
logdir="$localstatedir/log/$prog"
netmrg="$bindir/netmrg-gatherer"
lockfile="$logdir/lockfile"
output="$logdir/lastrun.log"
error="$logdir/lastrun.err"
curdate=`date +%s`

if [ -e $lockfile ] ; then
	lastrun=`cat $lockfile`;
	rundiff=$(($curdate - $lastrun));
	echo "NetMRG died on its run $rundiff seconds ago.  I'll remove the lockfile" | mail -s "NetMRG died at $lastrun" $mailto
	mv -f $output $output.$lastrun
	mv -f $error $error.$lastrun
	rm -f $lockfile
fi

$netmrg > $output 2> $error
